{% extends "base.html" %}

{% block title %}Design Tool - API 650 Designer{% endblock %}

{% block content %}
<div class="container my-5" style="padding-top: 56px;">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold text-primary mb-3">
                    <i class="fas fa-calculator me-3"></i>
                    Tank Design Calculator
                </h1>
                <p class="lead text-muted">
                    Enter your process parameters to calculate optimal tank specifications
                    following API 650 standards.
                </p>
            </div>

            <!-- Design Form -->
            <form method="POST" action="{{ url_for('calculate') }}" class="needs-validation" novalidate>
                <div class="card mb-4 border-light shadow-sm">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-industry me-2 text-primary"></i>
                            Process Parameters
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="production_rate" class="form-label fw-bold">
                                    Production Rate <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="production_rate"
                                           name="production_rate" step="0.1" min="0.1" required>
                                    <span class="input-group-text">TPD</span>
                                </div>
                                <div class="form-text">Tonnes per day production rate</div>
                                <div class="invalid-feedback">
                                    Please provide a valid production rate.
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="holding_period" class="form-label fw-bold">
                                    Holding Period <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="holding_period"
                                           name="holding_period" step="0.5" min="0.5" required>
                                    <span class="input-group-text">days</span>
                                </div>
                                <div class="form-text">Storage duration in days</div>
                                <div class="invalid-feedback">
                                    Please provide a valid holding period.
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="chemical_select" class="form-label fw-bold">Chemical Selection</label>
                                <select class="form-select" id="chemical_select" name="chemical_name" onchange="updateChemicalProperties()">
                                    <option value="">Select Chemical</option>
                                    {% for chem_id, chem_name in chemicals %}
                                    <option value="{{ chem_id }}">{{ chem_name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Select from database or enter custom values below</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="density" class="form-label fw-bold">Liquid Density</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="density"
                                           name="density" value="1000" step="1" min="1">
                                    <span class="input-group-text">kg/m³</span>
                                </div>
                                <div class="form-text" id="density-info">Default: 1000 kg/m³ (water)</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="max_fill_fraction" class="form-label fw-bold">Maximum Fill Fraction</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="max_fill_fraction"
                                           name="max_fill_fraction" value="85" step="1" min="70" max="95">
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="form-text">Default: 85% (API 650 recommendation)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Design Parameters Card -->
                <div class="card mb-4 border-light shadow-sm">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tools me-2 text-primary"></i>
                            Design Parameters
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="corrosion_allowance" class="form-label fw-bold">Corrosion Allowance</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="corrosion_allowance"
                                           name="corrosion_allowance" value="1.5" step="0.1" min="0" max="10">
                                    <span class="input-group-text">mm</span>
                                </div>
                                <div class="form-text" id="corrosion-info">Default: 1.5mm</div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="num_tanks" class="form-label fw-bold">Number of Tanks</label>
                                <select class="form-select" id="num_tanks" name="num_tanks">
                                    <option value="1">1 Tank</option>
                                    <option value="2" selected>2 Tanks</option>
                                    <option value="3">3 Tanks</option>
                                    <option value="4">4 Tanks</option>
                                </select>
                                <div class="form-text">Default: 2 tanks (for redundancy)</div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="design_margin" class="form-label fw-bold">Design Margin</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="design_margin"
                                           name="design_margin" value="10" step="1" min="0" max="50">
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="form-text">Default: 10% (for future capacity)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <button type="reset" class="btn btn-outline-secondary me-md-2">
                        <i class="fas fa-undo me-2"></i>
                        Reset Form
                    </button>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-calculator me-2"></i>
                        Calculate Tank Design
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Bootstrap form validation
    (function() {
        'use strict';
        window.addEventListener('load', function() {
            var forms = document.getElementsByClassName('needs-validation');
            var validation = Array.prototype.filter.call(forms, function(form) {
                form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();

    // Update chemical properties when selection changes
    function updateChemicalProperties() {
        const select = document.getElementById('chemical_select');
        const chemicalId = select.value;

        if (!chemicalId) {
            // Reset to default if no chemical is selected
            document.getElementById('density').value = 1000;
            document.getElementById('corrosion_allowance').value = 1.5;
            document.getElementById('density-info').textContent = 'Default: 1000 kg/m³ (water)';
            document.getElementById('corrosion-info').textContent = 'Default: 1.5mm';
            return;
        }

        fetch(`/get_chemical_properties/${chemicalId}`)
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    // Update form fields
                    document.getElementById('density').value = data.density;
                    document.getElementById('corrosion_allowance').value = data.corrosion_allowance;

                    // Update info text
                    document.getElementById('density-info').textContent =
                        `${data.density} kg/m³ (${data.name})`;
                    document.getElementById('corrosion-info').textContent =
                        `${data.corrosion_allowance}mm (${data.corrosivity} corrosivity)`;
                }
            })
            .catch(error => {
                console.error('Error fetching chemical properties:', error);
            });
    }

    // Load saved form data on page load
    document.addEventListener('DOMContentLoaded', function() {
        const savedData = localStorage.getItem('tankDesignFormData');
        if (savedData) {
            const data = JSON.parse(savedData);
            Object.keys(data).forEach(key => {
                const input = document.querySelector(`[name="${key}"]`);
                if (input && !input.value) { // Only fill if not already populated (e.g., by server)
                    input.value = data[key];
                }
            });
        }

        // Auto-save form data on input
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('input', function() {
                const formData = new FormData(form);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }
                localStorage.setItem('tankDesignFormData', JSON.stringify(data));
            });
        }
    });
</script>
{% endblock %}

