{% extends "base.html" %}

{% block title %}Results - API 650 Designer{% endblock %}

{% block content %}
<div class="container my-5" style="padding-top: 56px;">
    <!-- Header -->
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold text-primary mb-3">
            <i class="fas fa-chart-bar me-3"></i>
            Tank Design Results
        </h1>
        <p class="lead text-muted">
            Professional tank specifications calculated per API 650 standards
        </p>
    </div>

    <!-- Design Summary -->
    <div class="row mb-5">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-light shadow-sm text-center h-100">
                <div class="card-body">
                    <div class="text-primary mb-2">
                        <i class="fas fa-droplet fa-2x"></i>
                    </div>
                    <h5 class="card-title">Total Storage</h5>
                    <h3 class="text-primary">{{ "%.1f"|format(results.storage.geometric_volume) }}</h3>
                    <small class="text-muted">m³ required</small>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-light shadow-sm text-center h-100">
                <div class="card-body">
                    <div class="text-success mb-2">
                        <i class="fas fa-arrows-alt fa-2x"></i>
                    </div>
                    <h5 class="card-title">Tank Size</h5>
                    <h3 class="text-success">{{ results.dimensions.diameter }}×{{ results.dimensions.height }}</h3>
                    <small class="text-muted">D×H (meters)</small>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-light shadow-sm text-center h-100">
                <div class="card-body">
                    <div class="text-info mb-2">
                        <i class="fas fa-layer-group fa-2x"></i>
                    </div>
                    <h5 class="card-title">Shell Thickness</h5>
                    <h3 class="text-info">{{ results.shell.shell_thickness }}</h3>
                    <small class="text-muted">mm (API 650)</small>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-light shadow-sm text-center h-100">
                <div class="card-body">
                    <div class="text-warning mb-2">
                        <i class="fas fa-shield-alt fa-2x"></i>
                    </div>
                    <h5 class="card-title">Bund Volume</h5>
                    <h3 class="text-warning">{{ "%.1f"|format(results.bund_volume) }}</h3>
                    <small class="text-muted">m³ (110%)</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Tank Specifications Table -->
    <div class="card mb-5 border-light shadow-sm">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-table me-2 text-primary"></i>
                Tank Specifications
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Tank No</th>
                            <th>Chemical to Store</th>
                            <th>Capacity (m³)</th>
                            <th>Dimensions (D×H)</th>
                            <th>Shell Thickness (mm)</th>
                            <th>Bottom (mm)</th>
                            <th>Roof (mm)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tank in results.tank_specifications %}
                        <tr>
                            <td class="fw-bold">{{ tank.tank_no }}</td>
                            <td>{{ tank.chemical }}</td>
                            <td>{{ "%.1f"|format(tank.capacity) }}</td>
                            <td>{{ tank.diameter }}×{{ tank.height }}</td>
                            <td class="text-primary fw-bold">{{ tank.shell_thickness }}</td>
                            <td>{{ results.bottom_thickness }}</td>
                            <td>{{ results.roof_thickness }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tank Diagram and Interactive Chart -->
    <div class="row mb-5">
        <!-- Tank Diagram -->
        <div class="col-lg-4 mb-4">
            <div class="card border-light shadow-sm h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-eye me-2 text-primary"></i>
                        Tank Diagram
                    </h5>
                </div>
                <div class="card-body text-center">
                    <svg width="100%" height="300" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                        <rect x="75" y="80" width="150" height="180" fill="none" stroke="var(--bs-primary)" stroke-width="3"/>
                        <ellipse cx="150" cy="80" rx="75" ry="12" fill="none" stroke="var(--bs-primary)" stroke-width="3"/>
                        <ellipse cx="150" cy="260" rx="75" ry="12" fill="var(--bs-primary)" fill-opacity="0.1" stroke="var(--bs-primary)" stroke-width="3"/>
                        {% set fill_height = 180 * (inputs.max_fill_fraction / 100) %}
                        {% set liquid_y = 80 + (180 - fill_height) %}
                        <rect x="75" y="{{ liquid_y }}" width="150" height="{{ fill_height }}" fill="var(--bs-info)" fill-opacity="0.3"/>
                        <ellipse cx="150" cy="{{ liquid_y }}" rx="75" ry="12" fill="var(--bs-info)" fill-opacity="0.4" stroke="var(--bs-info)" stroke-width="2"/>
                        <line x1="240" y1="80" x2="240" y2="260" stroke="var(--bs-secondary)" stroke-width="2"/>
                        <line x1="235" y1="80" x2="245" y2="80" stroke="var(--bs-secondary)" stroke-width="2"/>
                        <line x1="235" y1="260" x2="245" y2="260" stroke="var(--bs-secondary)" stroke-width="2"/>
                        <text x="250" y="175" font-size="14" font-weight="bold" fill="var(--bs-secondary)">H={{ results.dimensions.height }}m</text>
                        <line x1="75" y1="280" x2="225" y2="280" stroke="var(--bs-secondary)" stroke-width="2"/>
                        <line x1="75" y1="275" x2="75" y2="285" stroke="var(--bs-secondary)" stroke-width="2"/>
                        <line x1="225" y1="275" x2="225" y2="285" stroke="var(--bs-secondary)" stroke-width="2"/>
                        <text x="130" y="295" font-size="14" font-weight="bold" fill="var(--bs-secondary)">D={{ results.dimensions.diameter }}m</text>
                        <line x1="75" y1="170" x2="65" y2="170" stroke="var(--bs-danger)" stroke-width="4"/>
                        <text x="25" y="175" font-size="12" font-weight="bold" fill="var(--bs-danger)">t={{ results.shell.shell_thickness }}mm</text>
                    </svg>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Cross-sectional view showing {{ inputs.max_fill_fraction }}% fill level
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interactive Chart -->
        <div class="col-lg-8 mb-4">
            <div class="card border-light shadow-sm h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2 text-primary"></i>
                        Shell Thickness vs Tank Height
                    </h5>
                </div>
                <div class="card-body">
                    <div id="thicknessChart" style="height: 300px;"></div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-mouse-pointer me-1"></i>
                            Interactive chart - hover for values, zoom and pan enabled
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Case & Export Options -->
    <div class="row mb-5">
        <div class="col-lg-6 mb-4">
            <div class="card border-light shadow-sm h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-save me-2 text-primary"></i>
                        Save Case for Comparison
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('save_case') }}" class="row align-items-end">
                        <div class="col-md-8 mb-3">
                            <label for="case_name" class="form-label">Case Name</label>
                            <input type="text" class="form-control" id="case_name" name="case_name"
                                   placeholder="e.g., Case 1 - High Production" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="fas fa-save me-2"></i>
                                Save Case
                            </button>
                        </div>
                    </form>
                    {% if session.get('saved_cases') %}
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            You have {{ session.saved_cases|length }} saved case(s).
                            <a href="{{ url_for('compare_cases') }}">Compare them</a>
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card border-light shadow-sm h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-download me-2 text-primary"></i>
                        Export Options
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                        <a href="{{ url_for('export_csv') }}" class="btn btn-info">
                            <i class="fas fa-file-csv me-2"></i>
                            Download CSV
                        </a>
                        <a href="{{ url_for('export_pdf') }}" class="btn btn-danger">
                            <i class="fas fa-file-pdf me-2"></i>
                            Download PDF Report
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="text-center">
        <a href="{{ url_for('design') }}" class="btn btn-outline-primary me-2">
            <i class="fas fa-arrow-left me-2"></i>
            New Calculation
        </a>
        <button onclick="window.print()" class="btn btn-outline-secondary">
            <i class="fas fa-print me-2"></i>
            Print Results
        </button>
    </div>
</div>

<div id="chart-data-container" data-chart='{{ chart_data | tojson | safe }}' style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chartDataContainer = document.getElementById('chart-data-container');
        const chartData = JSON.parse(chartDataContainer.dataset.chart);

        var trace = {
            x: chartData.heights,
            y: chartData.thicknesses,
            mode: 'lines+markers',
            type: 'scatter',
            name: 'Shell Thickness',
            line: {
                color: 'var(--bs-primary)',
                width: 3
            },
            marker: {
                color: 'var(--bs-primary)',
                size: 8
            }
        };

        var layout = {
            title: {
                text: chartData.title,
                font: { size: 16, color: 'var(--bs-body-color)' }
            },
            xaxis: {
                title: chartData.x_title,
                gridcolor: 'rgba(128,128,128,0.1)',
                color: 'var(--bs-body-color)'
            },
            yaxis: {
                title: chartData.y_title,
                gridcolor: 'rgba(128,128,128,0.1)',
                color: 'var(--bs-body-color)'
            },
            plot_bgcolor: 'rgba(0,0,0,0)',
            paper_bgcolor: 'rgba(0,0,0,0)',
            font: {
                color: 'var(--bs-body-color)'
            },
            margin: {
                l: 50, r: 50, t: 50, b: 50
            }
        };

        var config = {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
            displaylogo: false
        };

        Plotly.newPlot('thicknessChart', [trace], layout, config);
    });
</script>
{% endblock %}
